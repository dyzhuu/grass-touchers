<script lang="ts">
	import { PUBLIC_MAPS_API_KEY as apiKey } from '$env/static/public';
	import { Loader } from '@googlemaps/js-api-loader';
	import { element } from 'svelte/internal';

	// Constants
	const RED = "#c40f18";
	const GREEN = "#00FF00";
	const GRAY = "#969696";

	// Globals
	var previousLocations = [[-36.850307, 174.767681]];  //Dummy location
	var userPosition:number[];

	function getUserPosition(): Promise<[number, number]> {
		return new Promise((res, rej) => {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(
					(position) => {
						res([position.coords.latitude, position.coords.longitude]);
					},
					(error) => {
						rej(error);
					}
				);
			} else {
				rej(new Error('Geolocation is not supported by this browser.'));
			}
		});
	}

	function updateMarker(marker:google.maps.Marker){
		const new_latlng = new google.maps.LatLng(userPosition[0], userPosition[1]);
		marker.setPosition(new_latlng);
		// for debugging
		// console.log(new_position, "hello")
		// const new_latlng = new google.maps.LatLng(marker.getPosition().lat() + 1, marker.getPosition().lng() + 1);
	}

	function updateRegion(parks:google.maps.Polygon[]) {
		// Logic for user detection in region
		const currentPosition = new google.maps.LatLng(userPosition[0], userPosition[1]);
		parks.forEach((park) => {
			if (google.maps.geometry.poly.containsLocation(currentPosition, park)) {
				park.setOptions({fillColor: RED});
			} else {
				previousLocations.forEach((coordinate) => {
					const lastPosition = new google.maps.LatLng(coordinate[0], coordinate[1]);
					if (google.maps.geometry.poly.containsLocation(lastPosition, park)) {
						park.setOptions({fillColor: GRAY});
					}
				})
			}
		});
	}

	function map(div: HTMLDivElement) {
		const interval = 3;
		const loader = new Loader({
			apiKey,
			version: 'weekly'
		});

		(async () => {
			const { Map } = await loader.importLibrary('maps');

			//const { Marker } = await loader.importLibrary("marker");

			userPosition = await getUserPosition();

			const position = new google.maps.LatLng(userPosition[0], userPosition[1]);

			let main_map = new Map(div, {
				zoom: 14,
				center: position,
				mapId: 'DEMO_MAP_ID'
			});

			let user_position_marker = new google.maps.Marker({position: position, title: "YOU!"});

			user_position_marker.setMap(main_map);

			// loop this for each park

			const AlbertParkTop = [
				[174.767006, -36.8491229],
				[174.7670179, -36.8491449],
				[174.7670409, -36.8491538],
				[174.7670704, -36.849148],
				[174.769695, -36.8483469],
				[174.7697244, -36.8482685],
				[174.7694134, -36.8481976],
				[174.7690788, -36.8481638],
				[174.768641, -36.8482079],
				[174.7681947, -36.8483149],
				[174.7676776, -36.8485253],
				[174.7673189, -36.848775],
				[174.7670405, -36.8490839],
				[174.767006, -36.8491229]
			];

			const AlbertParkBottom = [
				[174.7663649, -36.8506673],
				[174.7664939, -36.8507023],
				[174.7666174, -36.8507358],
				[174.7665951, -36.8508286],
				[174.7667629, -36.8508674],
				[174.7667558, -36.8508884],
				[174.7667435, -36.8509251],
				[174.7665381, -36.8515348],
				[174.7665626, -36.8517073],
				[174.766421, -36.8517999],
				[174.7672955, -36.8525169],
				[174.7673545, -36.8525652],
				[174.7673866, -36.8525387],
				[174.7674779, -36.8524632],
				[174.7675126, -36.8524375],
				[174.7680243, -36.8519387],
				[174.7680655, -36.8518553],
				[174.7681088, -36.8517585],
				[174.7681421, -36.8517136],
				[174.7681501, -36.8516948],
				[174.7682972, -36.851349],
				[174.7684291, -36.8510665],
				[174.7685478, -36.8508124],
				[174.7685534, -36.8508003],
				[174.7685745, -36.8507481],
				[174.7687684, -36.8503325],
				[174.7688044, -36.8502597],
				[174.7688538, -36.8501596],
				[174.7684976, -36.850072],
				[174.7685889, -36.8498079],
				[174.768615, -36.8497324],
				[174.7687295, -36.849465],
				[174.7685578, -36.8494307],
				[174.7688754, -36.8488057],
				[174.7689073, -36.8487327],
				[174.7687669, -36.8487746],
				[174.7687359, -36.8487838],
				[174.7679177, -36.8490277],
				[174.7671474, -36.8492768],
				[174.7669414, -36.8493867],
				[174.7668556, -36.849476],
				[174.7663649, -36.8506673]
			];

			const OGGB = [
				[174.7708412, -36.8529633],
				[174.7708607, -36.8531418],
				[174.7709281, -36.8537183],
				[174.771066, -36.8536436],
				[174.771093, -36.8536353],
				[174.771108, -36.853671],
				[174.7711224, -36.853705],
				[174.7711475, -36.8537439],
				[174.7711609, -36.8536985],
				[174.7713148, -36.8536098],
				[174.7713436, -36.8536372],
				[174.7713657, -36.8536275],
				[174.7713309, -36.8535815],
				[174.7713647, -36.8535633],
				[174.7712979, -36.8534937],
				[174.7712138, -36.853406],
				[174.7711677, -36.853358],
				[174.7713441, -36.853209],
				[174.7714317, -36.853228],
				[174.7715824, -36.8532607],
				[174.7716698, -36.8532797],
				[174.7717297, -36.8530936],
				[174.7718133, -36.8530826],
				[174.7718195, -36.8531157],
				[174.7720071, -36.8529799],
				[174.77198, -36.8529623],
				[174.771938, -36.85293],
				[174.7718779, -36.8528821],
				[174.7718062, -36.8529385],
				[174.7714623, -36.8530387],
				[174.7712707, -36.8530883],
				[174.7712252, -36.853086],
				[174.771184, -36.8530746],
				[174.7711479, -36.8530474],
				[174.7711372, -36.853019],
				[174.771132, -36.8529846],
				[174.7711697, -36.8528095],
				[174.771196, -36.8527246],
				[174.7712171, -36.8526932],
				[174.7713035, -36.8526227],
				[174.7712594, -36.8525864],
				[174.7711946, -36.852533],
				[174.7711665, -36.8525098],
				[174.7711507, -36.8525673],
				[174.7711418, -36.8525995],
				[174.7711136, -36.8525962],
				[174.771091, -36.8526586],
				[174.7710542, -36.8526544],
				[174.7710257, -36.8528041],
				[174.7709462, -36.8527987],
				[174.7709494, -36.8529567],
				[174.7709011, -36.852962],
				[174.7708412, -36.8529633]
			];

			const SiloPark = [
				[174.7535634, -36.8399564],
				[174.7537681, -36.8400148],
				[174.7537723, -36.8400039],
				[174.7547203, -36.840255],
				[174.7547136, -36.8402741],
				[174.7551279, -36.8403819],
				[174.7558696, -36.8405807],
				[174.7558961, -36.840585],
				[174.7559213, -36.8405837],
				[174.7559407, -36.8405797],
				[174.7559558, -36.8405713],
				[174.7559652, -36.840563],
				[174.7559789, -36.8405294],
				[174.7560123, -36.8404493],
				[174.7560175, -36.8404362],
				[174.7560353, -36.8403938],
				[174.7560389, -36.8403828],
				[174.7560502, -36.8403558],
				[174.756058, -36.8403387],
				[174.7560706, -36.8403084],
				[174.7561048, -36.8402293],
				[174.7561954, -36.8400093],
				[174.7555554, -36.8395444],
				[174.755526, -36.839522],
				[174.7554847, -36.8394908],
				[174.7554637, -36.8394766],
				[174.7554137, -36.8395246],
				[174.7552892, -36.8396363],
				[174.755248, -36.8396404],
				[174.755225, -36.8397029],
				[174.7550464, -36.8395999],
				[174.7547835, -36.8394118],
				[174.7545268, -36.8392142],
				[174.7545254, -36.8392189],
				[174.7545138, -36.8392103],
				[174.7544278, -36.8391473],
				[174.7543671, -36.8392004],
				[174.7544513, -36.8392622],
				[174.7544647, -36.839272],
				[174.754099, -36.8395891],
				[174.7542176, -36.8396187],
				[174.7541068, -36.8397044],
				[174.7539787, -36.8396689],
				[174.7537146, -36.8395978],
				[174.7536979, -36.8396379],
				[174.7536792, -36.8396828],
				[174.7536692, -36.8397048],
				[174.7536645, -36.8397166],
				[174.7536598, -36.8397282],
				[174.7535708, -36.8399396],
				[174.7535634, -36.8399564]
			];

			const Waiatarau_VictoriaPark = [
				[174.7513815, -36.8479827],
				[174.7513853, -36.8479972],
				[174.751398, -36.8480099],
				[174.7514127, -36.8480187],
				[174.7514343, -36.848022],
				[174.7514601, -36.8480211],
				[174.7516219, -36.8480158],
				[174.7520883, -36.8479698],
				[174.7525903, -36.8479786],
				[174.7527952, -36.8479823],
				[174.7533533, -36.8479921],
				[174.753459, -36.8479931],
				[174.7536253, -36.8479948],
				[174.7550726, -36.848009],
				[174.7552031, -36.8480106],
				[174.7554752, -36.8480148],
				[174.755475, -36.8479854],
				[174.7555646, -36.8479868],
				[174.7556948, -36.8479887],
				[174.7556936, -36.8480024],
				[174.7559692, -36.8480025],
				[174.7560792, -36.8479798],
				[174.7561262, -36.8479585],
				[174.7561792, -36.8479345],
				[174.7561968, -36.8479229],
				[174.7562321, -36.8478967],
				[174.7562713, -36.8478569],
				[174.7562936, -36.8478127],
				[174.7563717, -36.8464175],
				[174.7563665, -36.8463324],
				[174.7563592, -36.846308],
				[174.7563423, -36.8462642],
				[174.7563079, -36.84622],
				[174.7562642, -36.8461759],
				[174.7561788, -36.8461282],
				[174.7560572, -36.846086],
				[174.7546497, -36.8457641],
				[174.7541917, -36.8456407],
				[174.7540058, -36.845588],
				[174.7539561, -36.8455749],
				[174.7539071, -36.8455551],
				[174.7538854, -36.8455464],
				[174.7537369, -36.8455002],
				[174.753525, -36.8454433],
				[174.7531146, -36.8453249],
				[174.7530837, -36.8453221],
				[174.7530537, -36.8453346],
				[174.7520854, -36.8468593],
				[174.7520691, -36.8468849],
				[174.751784, -36.8473338],
				[174.7513924, -36.8479484],
				[174.7513815, -36.8479827]
			];

			const Pukekawa_AucklandDomain = [
				[174.7705268, -36.8618065],
				[174.7707195, -36.8623548],
				[174.7711957, -36.8637092],
				[174.7712646, -36.8639053],
				[174.7712919, -36.8639422],
				[174.7713098, -36.8639601],
				[174.7713361, -36.8639839],
				[174.7713727, -36.8640112],
				[174.7713891, -36.8640234],
				[174.7714258, -36.864047],
				[174.7714717, -36.8640721],
				[174.7739535, -36.8645709],
				[174.7740041, -36.8645379],
				[174.7740503, -36.864531],
				[174.7750733, -36.8641411],
				[174.7761386, -36.8635167],
				[174.7767874, -36.8631849],
				[174.7770602, -36.8631979],
				[174.7773682, -36.8632458],
				[174.7780483, -36.8633794],
				[174.7797965, -36.8617924],
				[174.7792137, -36.8613684],
				[174.7792363, -36.8613487],
				[174.7798286, -36.8608157],
				[174.7804095, -36.8612139],
				[174.7804186, -36.8612202],
				[174.7808186, -36.8609658],
				[174.7806235, -36.8606257],
				[174.7803612, -36.8601807],
				[174.7804019, -36.8601682],
				[174.7800846, -36.8596073],
				[174.7782557, -36.856348],
				[174.7782272, -36.8564046],
				[174.7781735, -36.8564373],
				[174.7781526, -36.8564667],
				[174.7780948, -36.8564695],
				[174.778098, -36.8563862],
				[174.7781268, -36.8563387],
				[174.7781765, -36.8563375],
				[174.7780262, -36.8560785],
				[174.7778908, -36.8557659],
				[174.777863, -36.8557016],
				[174.777373, -36.8548329],
				[174.7771575, -36.8544508],
				[174.7770901, -36.8542703],
				[174.7770271, -36.8541559],
				[174.776972, -36.8541013],
				[174.7769241, -36.8540139],
				[174.776747, -36.8536777],
				[174.7766547, -36.8538065],
				[174.7764247, -36.8540581],
				[174.77636, -36.8541308],
				[174.7762739, -36.8540776],
				[174.7760484, -36.8543133],
				[174.7752313, -36.8538075],
				[174.775286, -36.8537521],
				[174.7751974, -36.8536874],
				[174.7751535, -36.8536605],
				[174.7750696, -36.8537499],
				[174.7749491, -36.8539042],
				[174.7745488, -36.853634],
				[174.7741696, -36.8539554],
				[174.7738673, -36.854143],
				[174.7738931, -36.8545551],
				[174.772858, -36.8546487],
				[174.7724873, -36.854533],
				[174.7723066, -36.8544398],
				[174.7722305, -36.8545823],
				[174.7721339, -36.8545464],
				[174.7720572, -36.854532],
				[174.7720022, -36.854547],
				[174.7719713, -36.8545669],
				[174.771828, -36.8547491],
				[174.7717168, -36.8548682],
				[174.7716273, -36.8549577],
				[174.771459, -36.8551179],
				[174.7716078, -36.855176],
				[174.7715387, -36.8552666],
				[174.771909, -36.8555886],
				[174.771909, -36.8555986],
				[174.7713178, -36.8562792],
				[174.77139, -36.8563588],
				[174.7714144, -36.8563857],
				[174.7722275, -36.8564984],
				[174.7724082, -36.8571167],
				[174.7725658, -36.8573428],
				[174.7727991, -36.8578098],
				[174.7730952, -36.8581317],
				[174.7733126, -36.8588905],
				[174.7725895, -36.8589099],
				[174.7720789, -36.8591177],
				[174.7720237, -36.8591641],
				[174.7717631, -36.8597724],
				[174.7715156, -36.8609075],
				[174.7709336, -36.8617179],
				[174.7706102, -36.8617883],
				[174.7705268, -36.8618065]
			];

			// this const should reference all parks in database later
			const allParksCoords = [
				AlbertParkTop,
				AlbertParkBottom,
				OGGB,
				SiloPark,
				Waiatarau_VictoriaPark,
				Pukekawa_AucklandDomain
			];

			let allParksMap: google.maps.Polygon[] = [];
			allParksCoords.forEach((park) => {
				let parkCoords: google.maps.LatLng[] = [];
				park.forEach((element) => {
					parkCoords.push(new google.maps.LatLng(element[1], element[0]));
				});
				
				// Construct the polygon.
				const parkMap = new google.maps.Polygon({
					paths: parkCoords,
					strokeColor: "black",
					strokeOpacity: 0.8,
					strokeWeight: 2,
					fillColor: GREEN,
					fillOpacity: 0.35
				});

				parkMap.setMap(main_map);

				allParksMap.push(parkMap);
			})
			
			// Repeated events
			async function refreshPosition() {
				const new_pos = await getUserPosition();
				userPosition = new_pos;

				updateMarker(user_position_marker);

				updateRegion(allParksMap);

				setTimeout(refreshPosition, 1000 * interval);
			}
			refreshPosition();
		})();
	}
</script>

<div use:map id="map" class="m-5 w-full h-full" />
